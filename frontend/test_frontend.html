<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AI Accountant ‚Äì Test Frontend</title>

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background: #f4f6f8;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      max-height: 300px;
      overflow: auto;
    }
  </style>
</head>

<body>

<div class="container py-4">

  <h1 class="text-center mb-4">ü§ñ AI Accountant</h1>

  <div class="row g-4">

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h5>

          <input id="email" class="form-control mb-2" placeholder="Email" />
          <input id="password" type="password" class="form-control mb-3" placeholder="–ü–∞—Ä–æ–ª—å" />

          <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
            <button class="btn btn-outline-secondary" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </div>

          <pre id="authResult" class="mt-3"></pre>
        </div>
      </div>
    </div>

    <!-- –ó–∞–ø—Ä–æ—Å –∫ –ò–ò -->
    <div class="col-md-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">üí¨ –ó–∞–ø—Ä–æ—Å –∫ –ò–ò</h5>

          <textarea
            id="question"
            class="form-control mb-3"
            rows="3"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."
          ></textarea>

          <button class="btn btn-success" onclick="askAI()">–°–ø—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>

      <!-- –û—Ç–≤–µ—Ç –ò–ò -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">ü§ñ –û—Ç–≤–µ—Ç –ò–ò</h5>
          <pre id="aiResponse"></pre>
        </div>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üìú –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞</h5>
          <pre id="history"></pre>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  const API_BASE = ""
  let accessToken = null
  let sessionId = "test_session_frontend"
  let history = []

    function renderHistory(history) {
    return history
      .map(item => {
        const author =
          item.role === "user"
            ? "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
            : "ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç"

        return `${author}:\n${item.content}`
      })
      .join("\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n")
  }

  async function login() {
    const email = document.getElementById("email").value
    const password = document.getElementById("password").value

    const response = await fetch(`${API_BASE}/auth/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    })

  const data = await response.json()

    if (response.ok && data.access_token) {
      accessToken = data.access_token
      showAuthMessage("‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É")
    } else {
      showAuthMessage(data.detail || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞", "danger")
    }
  }

  async function register() {
    const email = document.getElementById("email").value
    const password = document.getElementById("password").value

    const response = await fetch(`${API_BASE}/auth/auth/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    })

    const data = await response.json()
    if (response.ok) {
      showAuthMessage("‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤–æ–π—Ç–∏.")
    } else {
      showAuthMessage(data.detail || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏", "danger")
    }
  }

  function showAuthMessage(message, type = "success") {
    const authResult = document.getElementById("authResult")

    authResult.textContent = message
    authResult.className = "mt-3 alert alert-" + type
  }


  async function askAI() {
    if (!accessToken) {
      alert("–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Å—è")
      return
    }

    const question = document.getElementById("question").value
    history.push({ role: "user", content: question })

    try {
      const response = await fetch(`${API_BASE}/api/v1/assistant/query`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${accessToken}`
        },
        body: JSON.stringify({
          query: question,
          session_id: sessionId,
          history: history
        })
      })

      const data = await response.json()
      history.push({ role: "assistant", content: data.answer })

      document.getElementById("aiResponse").textContent =
        JSON.stringify(data.answer, null, 2)

      document.getElementById("history").innerText =
        renderHistory(history)

    } catch (err) {
      console.error(err)
    }
  }
</script>

</body>
</html>
